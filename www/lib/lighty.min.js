"use strict";controllers.factory("DatabaseConnector",["$ionicPlatform","Error","Callback","Util","$timeout",function($ionicPlatform,Error,Callback,Util,$timeout){var DatabaseConnector=augment.defclass({constructor:function(tableName){this._tableName=tableName},deleteById:function(id,onSuccess,onFail){var deleteQuery="delete from "+this._tableName+" where id = "+id+";";DatabaseConnector.Query(deleteQuery,[],onSuccess,onFail)},updateById:function(id,params,onSuccess,onFail){var setQuery="SET ";var values=[];for(var column in params){setQuery+=column+" = ?, ";values.push(params[column])}setQuery=setQuery.substring(0,setQuery.length-2);var updateQuery="UPDATE "+this._tableName+" "+setQuery+" WHERE id = "+id+";";DatabaseConnector.Query(updateQuery,values,onSuccess,onFail)},insert:function(ChildModel,params,onSuccess,onFail){var columns="";var questionMarks="";var values=[];for(var column in params){columns+=column+", ";questionMarks+="?"+", ";values.push(params[column])}var columns="("+columns.substring(0,columns.length-2)+")";var questionMarks="("+questionMarks.substring(0,questionMarks.length-2)+")";var queryInsert="INSERT INTO "+this._tableName+columns+" VALUES"+questionMarks;var onInserted=new Callback(function(result){params["id"]=result.insertId;var childModel=new ChildModel(params);onSuccess.fire(childModel)});DatabaseConnector.Query(queryInsert,values,onInserted,onFail)},select:function(config){var tableName=this._tableName;var conditionsJson;var whereCondition="";var conditionValues=[];var limit="";var order="";var columns="*";var isDistinct=config.isDistinct||true;var distinct=isDistinct?"distinct ":"";if(config.conditions!=null){conditionsJson=DatabaseConnector._FormatConditions(config.conditions,config.conditionType);whereCondition=" WHERE "+conditionsJson.conditions;conditionValues=conditionsJson.values}if(config.limit!=null){limit=" limit 0, "+config.limit}if(config.order!=null){order=Util.String(" order by {0} {1}",[config.order.by,config.order.type])}if(config.columns!=null){columns="";for(var i=0;i<config.columns.length-1;i++){columns+=config.columns[i]+", "}columns+=config.columns[config.columns.length-1]}var querySelect="select "+distinct+columns+" from "+tableName+whereCondition+order+limit+";";var onSearched=new Callback(function(result){var config=onSearched.getExtras();var ClassName=config.model||config.Model||config.ChildModel;if(config.limit!=null&&config.limit==1){var childModel=new ClassName(result.rows.item(0));config.onSuccess.fire(childModel)}else{var childModelList=[];for(var i=0;i<result.rows.length;i++){var temp=new ClassName(result.rows.item(i));childModelList.push(temp)}config.onSuccess.fire(childModelList)}});onSearched.setExtras(config);DatabaseConnector.Query(querySelect,conditionValues,onSearched,config.onFail)},selectFirst:function(config){config.order={by:"id",type:DatabaseConnector.ORDER.FIRST};config.limit=1;this.select(config)},selectLast:function(config){config.order={by:"id",type:DatabaseConnector.ORDER.LAST};config.limit=1;this.select(config)}});DatabaseConnector.Connector=null;DatabaseConnector.Reset=function(){DatabaseConnector.Connector=null};DatabaseConnector.getConnector=function(onSuccess,onFail){var self=this;if(DatabaseConnector.Connector!=null){onSuccess.fire(DatabaseConnector.Connector);return}$ionicPlatform.ready(function(){if(window.sqlitePlugin==null){var error=new Error("sqlite plugin is undefined",true);onFail.fire(error);return}DatabaseConnector.Connector=window.sqlitePlugin.openDatabase({name:CONFIG.DATABASE.NAME});DatabaseConnector.Connector.transaction(function(tx){var tablesCreated=0,isOnSuccessCalled=false;for(var i=0;i<CONFIG.DATABASE.SCHEMA.TABLES.length;i++){tx.executeSql(CONFIG.DATABASE.SCHEMA.TABLES[i],[],function(){tablesCreated++;if(tablesCreated==CONFIG.DATABASE.SCHEMA.TABLES.length)onSuccess.fire(DatabaseConnector.Connector)},function(e){if(DatabaseConnector.Connector==null){var error=new Error(e.message,true);config.onFail.fire(error);return}if(DatabaseConnector.Connector!=null&&!isOnSuccessCalled){isOnSuccessCalled=true;onSuccess.fire(DatabaseConnector.Connector);return}})}},function(e){var error=new Error(e.message,true);config.onFail.fire(error)})})};DatabaseConnector.Query=function(query,values,onSuccess,onFail){var onConnected=new Callback(function(db){db.transaction(function(tx){tx.executeSql(query,values,function(tx,result){onSuccess.fire(result)},function(e){alert(Util.String("{0} error: {1}",[query,e.message]));Util.Alert(values);var error=new Error(e.message,true);onFail.fire(error)})})});DatabaseConnector.getConnector(onConnected,onFail)};DatabaseConnector._FormatConditions=function(params,conditionType){if(conditionType==null)conditionType=DatabaseConnector.CONDITION_OPERATOR.AND;var conditions="";var values=[];for(var i=0;i<params.length;i++){conditions+=params[i][0];if(params[i][2]==null)conditions+=" IS NULL";else if(params[i][2]==DatabaseConnector.CONDITION.NOT_NULL)conditions+=" IS NOT NULL";else{conditions+=" "+params[i][1]+" ?";values.push(params[i][2])}conditions+=" "+conditionType+" "}conditions=conditions.substring(0,conditions.length-(conditionType.length+2));return{conditions:conditions,values:values}};DatabaseConnector.CONDITION_OPERATOR={AND:"AND",OR:"OR"};DatabaseConnector.CONDITION={NOT_NULL:"NOT_NULL"};DatabaseConnector.ORDER={FIRST:"asc",LAST:"desc"};return DatabaseConnector}]);controllers.factory("Util",[function(){"use strict";var Util=augment.defclass({constructor:function(){}});Util.Alert=function(object){var jsonStringified="";try{jsonStringified=JSON.stringify(object)}catch(e){jsonStringified=object}alert(jsonStringified)};Util.ToTwoDigits=function(number){var baseTwo=number;if(number<10&&number>-10){baseTwo="0"+number}return baseTwo};Util.FormatMilliseconds=function(milliseconds){var days,hours,minutes,seconds;seconds=Math.floor(milliseconds/1e3);minutes=Math.floor(seconds/60);seconds=seconds%60;hours=Math.floor(minutes/60);minutes=minutes%60;days=Math.floor(hours/24);hours=hours%24;return Util.ToTwoDigits(hours)+":"+Util.ToTwoDigits(minutes)+":"+Util.ToTwoDigits(seconds)};Util.String=function(str,args){var regex=new RegExp("{-?[0-9]+}","g");return str.replace(regex,function(item){var intVal=parseInt(item.substring(1,item.length-1));var replace;if(intVal>=0){replace=args[intVal]}else if(intVal===-1){replace="{"}else if(intVal===-2){replace="}"}else{replace=""}return replace})};Util.Find=function(list,isMatched){for(var i=0;i<list.length;i++){if(isMatched(list[i]))return list[i]}return null};Util.IsString=function(value){return typeof value==="string"};Util.InArray=function(value,list){if(list.indexOf(value)===-1)return false;return true};Util.PushUnique=function(value,list,isMatched){var element=Util.Find(list,isMatched);if(element!=null){return}list.push(value)};Util.IsArrayLike=function(obj){var NODE_TYPE_ELEMENT=1;if(obj==null||Util.IsWindow(obj)){return false}var length=obj.length;if(obj.nodeType===NODE_TYPE_ELEMENT&&length){return true}return Util.IsString(obj)||Array.isArray(obj)||length===0||typeof length==="number"&&length>0&&length-1 in obj};Util.IsFunction=function(value){return typeof value==="function"};Util.IsWindow=function(obj){return obj&&obj.window===obj};Util.RandomNumber=function(min,max){if(!min)min=0;if(!max)max=1e3;return Math.floor(Math.random()*(max-min+1))+min};Util.ForEach=function(obj,iterator,context){var key,length;if(obj){if(Util.IsFunction(obj)){for(key in obj){if(key!="prototype"&&key!="length"&&key!="name"&&(!obj.hasOwnProperty||obj.hasOwnProperty(key))){iterator.call(context,obj[key],key,obj)}}}else if(Array.isArray(obj)||Util.IsArrayLike(obj)){var isPrimitive=typeof obj!=="object";for(key=0,length=obj.length;key<length;key++){if(isPrimitive||key in obj){iterator.call(context,obj[key],key,obj)}}}else if(obj.forEach&&obj.forEach!==Util.ForEach){obj.forEach(iterator,context,obj)}else{for(key in obj){if(obj.hasOwnProperty(key)){iterator.call(context,obj[key],key,obj)}}}}return obj};Util.EndWith=function(str,suffix){return str.indexOf(suffix,str.length-suffix.length)!==-1};Util.Base64=function(type,data){return Util.String("data:image/{0};base64,{1}",[type,data])};Util.RandomString=function(length){var text="";var possible="ABCDEFGHIJKLMNOPQRSTUVWXYZabcdefghijklmnopqrstuvwxyz0123456789";for(var i=0;i<length;i++)text+=possible.charAt(Math.floor(Math.random()*possible.length));return text};return Util}]);"use strict";controllers.factory("Callback",["$interval",function($interval){var Callback=augment.defclass({constructor:function(method,maxCalls){this._method=method||null;this._maxCalls=maxCalls||Callback.Calls.MAX;this._callsCounter=0},fire:function(param1,param2,param3){if(this._method&&this.isCallable()){Callback.Fire(this._method,param1,param2,param3);this._callsCounter++}return this},isFired:function(){return this._callsCounter>0},waitFiredOnce:function(){while(!this.isFired());},isCallable:function(){if(this._maxCalls==Callback.Calls.MAX)return true;return this._callsCounter<this._maxCalls},setExtras:function(extras){this._extras=extras;return this},getExtras:function(){return this._extras}});Callback.Fire=function(method,param1,param2,param3){if(method!=null){if(param1!=null&&param2!=null&&param3!=null)method(param1,param2,param3);else if(param1!=null&&param2!=null)method(param1,param2);else if(param1!=null)method(param1);else method()}};Callback.WaitAll=function(callBacks,onSuccess){var callsNumber;var interval=$interval(function(){callsNumber=0;for(var i=0;i<callBacks.length;i++){if(callBacks[i].isFired())callsNumber++}if(callsNumber==callBacks.length){$interval.cancel(interval);onSuccess.fire()}},100)};Callback.Calls={MAX:-1};return Callback}]);"use strict";controllers.factory("Error",["$timeout",function($timeout){var Error=augment.defclass({constructor:function(message,isShown,isCritical){this.message=message?message:null;this._isShown=isShown||false;this._isCritical=isCritical||false;if(this._isShown)this._onMessageShow()},show:function(message){this._onMessageShow();if(message)this.message=message;this._isShown=true;return this},hide:function(){this._isShown=false;return this},isShown:function(){return this._isShown},isCritical:function(){return this._isCritical},critical:function(isCritical){this._isCritical=isCritical;return this},getMessage:function(){return this.message},_onMessageShow:function(){var self=this;$timeout(function(){self.hide()},3e3)}});return Error}]);controllers.factory("Geolocation",["Error","Util",function(Error,Util){"use strict";var Geolocation=augment.defclass({constructor:function(){this.watchId=null},latlngToAddress:function(position,onSuccess,onFail){var geocoder=new google.maps.Geocoder;geocoder.geocode({latLng:position},function(results,status){if(status==google.maps.GeocoderStatus.OK){if(results[0]){onSuccess.fire(results[0].formatted_address)}else{onFail.fire("No results found")}}else{onFail.fire("Geocoder failed due to: "+status)}})},isLocationEnabled:function(onSuccess,onFail){cordova.plugins.diagnostic.isLocationEnabledSetting(function(isEnabled){onSuccess.fire(isEnabled)},function(e){onFail.fire(new Error(e,true,true))})},openLocationSettings:function(){cordova.plugins.diagnostic.switchToLocationSettings()},findPosition:function(onSuccess,onError){navigator.geolocation.getCurrentPosition(function(r){var position=Geolocation.ParsePosition(r.coords);if(onSuccess)onSuccess.fire(position)},function(e){if(onError)onError.fire(new Error("Can not initialize service no gps data! change your location!",true,true))},{timeout:1e4,enableHighAccuracy:true})},watch:function(onSuccess,onError){this.watchId=navigator.geolocation.watchPosition(function(r){var position=Geolocation.ParsePosition(r.coords);onSuccess.fire(position)},function(){if(onError)onError.fire(new Error("Failed to find your position, maybe you are in a building."))},{enableHighAccuracy:true})},stopWatching:function(){navigator.geolocation.clearWatch(this.watchId)}});Geolocation.ParsePosition=function(coords){var parsedCoords=null;if(Util.IsString(coords)){parsedCoords={latitude:parseFloat(coords.split(",")[0]),longitude:parseFloat(coords.split(",")[1]),accuracy:null}}else if(Util.IsFunction(coords.lat)&&Util.IsFunction(coords.lng)){parsedCoords={latitude:coords.lat(),longitude:coords.lng(),accuracy:coords.accuracy||null}}else if(coords.latitude&&coords.longitude){parsedCoords=coords}else{return null}var position={toLatLng:function(){return new google.maps.LatLng(parsedCoords.latitude,parsedCoords.longitude)},lat:function(){return parsedCoords.latitude},lng:function(){return parsedCoords.longitude},calculateDistance:function(pos){pos=Geolocation.ParsePosition(pos);var distance=google.maps.geometry.spherical.computeDistanceBetween(this.toLatLng(),pos.toLatLng());return distance},accuracy:parsedCoords.accuracy};return position};return Geolocation}]);"use strict";controllers.factory("Http",["Callback","$http","Error","$ionicLoading",function(Callback,$http,Error,$ionicLoading){var Http=augment.defclass({constructor:function(){this.isLoading=true;this.url=null;this.timeout=1e4},service:function(serviceUrl){this.url=CONFIG.SERVER.URL+serviceUrl;return this},get:function(config){var self=this;if(this.isLoading)Http._showLoading();Http.Get({url:config.url||this.url,timeout:this.timeout,model:config.model,params:config.params,onAnyResponse:new Callback(function(){if(self.isLoading)Http._hideLoading();if(config.onAnyResponse)config.onAnyResponse.fire()}),onSuccess:config.onSuccess,onFail:config.onFail,onError:config.onError})},post:function(config){var self=this;if(this.isLoading)Http._showLoading();Http.Post({url:config.url||this.url,timeout:this.timeout,model:config.model,params:config.params,onAnyResponse:new Callback(function(){if(self.isLoading)Http._hideLoading();if(config.onAnyResponse)config.onAnyResponse.fire()}),onSuccess:config.onSuccess,onFail:config.onFail,onError:config.onError})}});Http._checkHttpResponse=function(data,config){var parsedData=null;if(data.status==="SUCCESS"){if(config.model){if(data.result===null){parsedData=null}else if(Array.isArray(data.result)){parsedData=[];for(var i=0;i<data.result.length;i++){parsedData.push(new config.model(data.result[i]))}}else{parsedData=new config.model(data.result)}}else{parsedData=data.result}if(config.onSuccess)config.onSuccess.fire(parsedData)}else{if(config.onFail)config.onFail.fire(new Error(data.result||"Unkown error happened while connecting to server!",true,true),data.status,data.result)}};Http._onHttpError=function(config){var error=new Error("Check your internet connectivity",true,true);if(config.onError)config.onError.fire(error)};Http._showLoading=function(){if(Http.IsLoading()){$ionicLoading.show({template:"<ion-spinner></ion-spinner>"})}};Http._hideLoading=function(){$ionicLoading.hide()};Http.Post=function(config){$http({headers:{"Content-Type":"application/x-www-form-urlencoded; charset=utf-8"},transformRequest:function(obj){var str=[];for(var p in obj)str.push(encodeURIComponent(p)+"="+encodeURIComponent(obj[p]));return str.join("&")},url:config.url,method:"POST",data:config.params,timeout:config.timeout}).success(function(data,status,response){if(config.onAnyResponse)config.onAnyResponse.fire();Http._checkHttpResponse(data,config)}).error(function(){if(config.onAnyResponse)config.onAnyResponse.fire();Http._onHttpError(config)})};Http.Get=function(config){if(!config.params)config.params={};config.params.token="f837f625e15edf84dff132959e79e";$http({headers:{"Content-Type":"application/json; charset=utf-8"},url:config.url,method:"GET",params:config.params,timeout:config.timeout}).success(function(data,status,response){if(config.onAnyResponse)config.onAnyResponse.fire();Http._checkHttpResponse(data,config)}).error(function(e,s,h){if(config.onAnyResponse)config.onAnyResponse.fire();Http._onHttpError(config)})};Http.Ping=function(onSuccess,onFail,domain){var pingUrl=CONFIG.SERVER.URL;Http.Get({url:pingUrl,onSuccess:onSuccess,onError:onFail})};Http.Loading=true;Http.IsLoading=function(isLoading){if(typeof isLoading!=="undefined")Http.Loading=isLoading;return Http.Loading};return Http}]);"use strict";controllers.factory("Validator",["Error","Util",function(Error,Util){var Validator=augment.defclass({constructor:function(){this._error=new Error;this._blockMessage="";this._isPassed=true},_validate:function(isValid,errorMessage,inputId){inputId=!inputId?null:inputId;var isValidFlag=false;if(isValid())isValidFlag=true;this._isPassed=this._isPassed&&!isValidFlag;if(errorMessage!=null&&isValidFlag){this._error.show(errorMessage);this._blockMessage=this._blockMessage.length===0?errorMessage:this._blockMessage+" and "+errorMessage}if(inputId!==null){var inputElem=angular.element(document.getElementById(inputId));if(isValidFlag){inputElem.addClass("input-error")}else{inputElem.removeClass("input-error")}}return isValidFlag},isEmpty:function(value,errorMessage,inputId){return this._validate(function(){return!value||value.length==0},errorMessage,inputId)},isNull:function(value,errorMessage,inputId){return this._validate(function(){return value==null},errorMessage,inputId)},isNotEmail:function(value,errorMessage,inputId){return this._validate(function(){var re=/^(([^<>()[\]\\.,;:\s@\"]+(\.[^<>()[\]\\.,;:\s@\"]+)*)|(\".+\"))@((\[[0-9]{1,3}\.[0-9]{1,3}\.[0-9]{1,3}\.[0-9]{1,3}\])|(([a-zA-Z\-0-9]+\.)+[a-zA-Z]{2,}))$/;return!re.test(value)},errorMessage,inputId)},isNotNumber:function(value,errorMessage,inputId){return this._validate(function(){return!value||isNaN(value)},errorMessage,inputId)},isIn:function(values,isMatched,errorMessage,inputId){return this._validate(function(){return Util.Find(values,isMatched)!=null},errorMessage,inputId)},getError:function(){return this._error},getErrorBlock:function(){var error=new Error;console.log(this._blockMessage);error.show(this._blockMessage);return error},isPassed:function(){return this._isPassed}});return Validator}]);controllers.factory("ImageManager",["Error","$cordovaFileTransfer","Util","Http","Callback",function(Error,$cordovaFileTransfer,Util,Http,Callback){"use strict";var ImageManager=augment.defclass({constructor:function(){this.cameraOptions={};this.filePath=null;if(typeof cordova!=="undefined"){this.cameraOptions={destinationType:Camera.DestinationType.FILE_URI,quality:60,correctOrientation:true}}},encoded:function(){this.cameraOptions.destinationType=Camera.DestinationType.DATA_URL;return this},locationed:function(){this.cameraOptions.destinationType=Camera.DestinationType.FILE_URI;return this},fromCamera:function(onSuccess,onError){var self=this;this.cameraOptions.sourceType=Camera.PictureSourceType.CAMERA;navigator.camera.getPicture(function(r){if(self.cameraOptions.destinationType===Camera.DestinationType.FILE_URI)self.filePath=r;onSuccess.fire(r)},function(e){if(onError)onError.fire(e,true,true)},this.cameraOptions);return this},fromGallery:function(onSuccess,onError){var self=this;this.cameraOptions.sourceType=Camera.PictureSourceType.PHOTOLIBRARY;navigator.camera.getPicture(function(r){if(self.cameraOptions.destinationType===Camera.DestinationType.FILE_URI)self.filePath=r;onSuccess.fire(r)},function(e){if(onError)onError.fire(e,true,true)},this.cameraOptions);return this},fileMetadata:function(onSuccess,onError){var imageUrl=this.filePath;var defaultError=new Error("Error happened while getting file data");window.resolveLocalFileSystemURL(imageUrl,function(fileEntry){fileEntry.file(function(fileObj){fileObj.isImage=function(){return fileObj.type.search("image")!==-1};onSuccess.fire(fileObj)},function(err){$rootScope.onError.fire(defaultError)})},function(err){$rootScope.onError.fire(defaultError)})},upload:function(url,onSuccess,onError,others){var self=this;if(this.filePath){$cordovaFileTransfer.upload(url,self.filePath,{fileKey:others.key||"image",fileName:self.filePath.substr(self.filePath.lastIndexOf("/")+1),params:others.params}).then(function(result){var response=null;try{response=JSON.parse(result.response)}catch(e){response=result.response}onSuccess.fire(response)},function(err){var e=null;switch(err.code){case FileTransferError.FILE_NOT_FOUND_ERR:case FileTransferError.INVALID_URL_ERR:e=new Error("Invalid file, Please reselect profile picture");break;case FileTransferError.CONNECTION_ERR:e=new Error("Connection error, Please check your internet connection");break;case FileTransferError.ABORT_ERR:e=new Error("User signup aborted");break;default:e=new Error("Unknown error happened while connecting to server, please try again");break}if(onError)onError.fire(e)},function(progress){})}else{var http=new Http;http.isLoading=false;http.post({url:url,params:others.params,onSuccess:onSuccess,onFail:new Callback(function(e){onError.fire(e)}),onError:onError})}},thumbnail:function(width,height,onSuccess,onError,others){var options={uri:this.filePath,folderName:others.folder||"Tmp",quality:others.quality||75,width:width,height:height};window.ImageResizer.resize(options,function(image){onSuccess.fire(image)},function(){onError.fire(new Error("Error happened while making image thumbnail"))})}});return ImageManager}]);controllers.factory("Model",["$ionicPlatform","DatabaseConnector","Util","$timeout",function($ionicPlatform,DatabaseConnector,Util,$timeout){"use strict";var Model=augment.defclass({constructor:function(row){this.id=row&&row.id?row.id:null;if(this._tableName!==null){this._dbConnector=new DatabaseConnector(this._tableName)}Util.ForEach(row,function(value,key){if(Util.InArray(key,this._fields))this[key]=value},this);this._bindMethods()},_bindMethods:function(){var self=this;this._modelType.Find=function(){self._dbConnector.selectFirst({model:self._modelType,conditions:{id:self.id},onSuccess:onSuccess,onFail:onError})}},getPrimaryKey:function(){return this.id},setPrimaryKey:function(id){this.id=id},"delete":function(onSuccess,onFail){this._dbConnector.deleteById(this.getPrimaryKey(),onSuccess,onFail);return this},update:function(onSuccess,onFail){this._dbConnector.updateById(this.getPrimaryKey(),this.toJson(),onSuccess,onFail);return this},save:function(onSuccess,onFail){if(this.id){this.update(onSuccess,onFail)}else{this._dbConnector.insert(this._modelType,this.toJson(),onSuccess,onFail)}return this},toString:function(){return this.id},toJson:function(){var json={id:this.id};Util.ForEach(this,function(value,key){if(Util.InArray(key,this._fields))json[key]=value},this);return json},toArray:function(){var fields=[];Util.ForEach(this,function(value,key){if(Util.InArray(key,this._fields))fields.push(value)},this);return fields},toList:function(){var json={};Util.ForEach(this,function(value,key){if(Util.InArray(key,this._fields)&&!Util.InArray(key,this._hidden))json[key]=value},this);return json}});Model.Find=function(model,params,order,onSuccess,onError){var tmp=new model;var tableName=tmp._tableName;var dbConnector=new DatabaseConnector(tableName);if(Array.isArray(params)){dbConnector.select({model:model,order:order,conditions:params,onSuccess:onSuccess,onFail:onError})}else{dbConnector.selectFirst({model:model,order:order,conditions:[["id","=",params]],onSuccess:onSuccess,onFail:onError})}};return Model}]);controllers.controller("HomeController@splash",["$scope","$state","$stateParams","$ionicHistory","$ionicPlatform","$cordovaDialogs","$rootScope","Callback","Geolocation","$ionicModal","$timeout","Settings","$ionicLoading",function($scope,$state,$stateParams,$ionicHistory,$ionicPlatform,$cordovaDialogs,$rootScope,Callback,Geolocation,$ionicModal,$timeout,Settings,$ionicLoading){"use strict"}]);controllers.controller("HomeController@landing",["$scope","$state","$stateParams","$translate","$ionicPlatform","$cordovaDialogs","$rootScope","Callback","Geolocation","$ionicModal","$timeout","Settings","$ionicLoading","User","$ionicHistory","Mode",function($scope,$state,$stateParams,$translate,$ionicPlatform,$cordovaDialogs,$rootScope,Callback,Geolocation,$ionicModal,$timeout,Settings,$ionicLoading,User,$ionicHistory,Mode){"use strict";$rootScope.onError=new Callback(function(e){$cordovaDialogs.alert(e.message,"Note")});$rootScope.onProgress=new Callback(function(){$ionicLoading.show({template:"<ion-spinner></ion-spinner>"})});$rootScope.onProgressDone=new Callback(function(){$ionicLoading.hide()});$rootScope.ifLocationEnabled=function(onEnabled,onNotEnabled){var locationoffModal=null;var g=new Geolocation;g.isLocationEnabled(new Callback(function(isEnabled){if(isEnabled)onEnabled.fire();else{if(locationoffModal!==null){locationoffModal.show();return}$ionicModal.fromTemplateUrl("templates/locationoff.modal.html",{scope:$scope,animation:"slide-in-up"}).then(function(modal){locationoffModal=modal;modal.show();$scope.onTurnOnLocationTapped=function(){modal.hide();g.openLocationSettings();if(onNotEnabled)onNotEnabled.fire();$timeout(function(){$rootScope.ifLocationEnabled(onEnabled,onNotEnabled)},7e3)}})}}),$rootScope.onError)};$rootScope.$on("$cordovaPush:notificationReceived",function(event,notification){if(ionic.Platform.isAndroid()){switch(notification.event){case"registered":if(notification.regid.length>0){User.getInstance().registerPushNotification(notification.regid)}break;case"message":$cordovaDialogs.alert(notification.message,"Message!");break;case"error":break;default:break}}else if(ionic.Platform.isIOS()){if(notification.alert){$cordovaDialogs.alert(notification.alert,"Message!")}}});Settings.Download(new Callback(function(){$rootScope.onContactUs=function(){$cordovaDialogs.confirm("Need Help? Don't hesitate to call us now","Customer Support",["Call","Cancel"]).then(function(buttonIndex){var btnIndex=buttonIndex;if(btnIndex===1){plugins.CallNumber.callNumber(function(){},function(e){$rootScope.onError.fire(new Error("Error while contacting customer support, try again later",true,true))},Settings.getInstance().e_number)}})}}));if(User.IsStored()){$ionicHistory.nextViewOptions({disableBack:true});Mode.FindAll(new Callback(function(){User.getInstance().signin(new Callback(function(){User.getInstance().store();User.InitPushNotification();User.getInstance().ping();User.getInstance().sync(new Callback(function(request){$state.go("menu.hailrequest",{request:request})}),new Callback(function(request){$state.go("menu.requestconfirmed",{request:request})}),new Callback(function(){$state.go("menu.hailrequest")}),$rootScope.onError)}),null,$rootScope.onError)}),$rootScope.onError)}var languageConfig={title:"Select a Language",items:[{text:"English",value:"en"},{text:"Arabic",value:"ar"}],doneButtonLabel:"Done",cancelButtonLabel:"Cancel"};$scope.onLanguageTapped=function(){if(typeof cordova==="undefined"){$translate.use("en");$state.go("authenticate");return}plugins.listpicker.showPicker(languageConfig,function(lang){if(lang==="en")$scope.language="ENGLISH";else if(lang==="ar")$scope.language="العربية";$translate.use(lang);$state.go("authenticate")},function(){})}}]);controllers.controller("HomeController@sidemenu",["$scope","$state","$stateParams","$ionicHistory","$timeout","$cordovaDialogs","Settings","$rootScope","Error",function($scope,$state,$stateParams,$ionicHistory,$timeout,$cordovaDialogs,Settings,$rootScope,Error){"use strict";$scope.menuWidth=window.innerWidth;$scope.onBackTapped=function(){if($ionicHistory.backView().stateName==="menu.hailrequest"){$ionicHistory.clearCache();$timeout($ionicHistory.goBack,50)}else{$ionicHistory.goBack()}}}]);controllers.controller("UserController@signin",["$scope","$state","$stateParams","$rootScope","Callback","User","$ionicHistory","$ionicPopup","Validator","$translate","Mode",function($scope,$state,$stateParams,$rootScope,Callback,User,$ionicHistory,$ionicPopup,Validator,$translate,Mode){"use strict";var popupConfirmPhone=null,popupConfirmCode=null;$scope.login={};Mode.FindAll();$scope.onLoginTapped=function(login){var validator=new Validator;validator.isEmpty(login.email,"Please enter your email address","login-email");validator.isEmpty(login.password,"Please enter your password","login-password");if(!validator.isPassed()){$rootScope.onError.fire(validator.getErrorBlock());return}User.getInstance().email=login.email;User.getInstance().password=login.password;User.getInstance().signin(new Callback(function(){User.InitPushNotification();$ionicHistory.nextViewOptions({disableBack:true});User.getInstance().store();User.getInstance().ping();User.getInstance().sync(new Callback(function(request){$state.go("menu.hailrequest",{request:request})}),new Callback(function(request){$state.go("menu.requestconfirmed",{request:request})}),new Callback(function(){$state.go("menu.hailrequest")}),$rootScope.onError)}),new Callback(function(mobileNumber){$scope.confirm={alert:true,message:"YOU CAN NOT LOGIN VERIFY YOUR NUMBER FIRST!",buttons:{isSubmit:true},input:{placeholder:"YOUR MOBILE NUMBER",data:mobileNumber,isAllowed:true}};$scope.onSubmitTapped=function(newMobile){popupConfirmPhone.close();User.getInstance().mobile=newMobile;User.getInstance().resendSms(new Callback(function(){$scope.confirm={message:null,buttons:{isSubmit:true},input:{placeholder:null,data:null,isAllowed:true}};$translate(["CONFIRM_CODE_MESSAGE","CONFIRMATION_CODE"]).then(function(translations){$scope.confirm.message=translations.CONFIRM_CODE_MESSAGE;$scope.confirm.input.placeholder=translations.CONFIRMATION_CODE});popupConfirmCode=$ionicPopup.confirm({templateUrl:"templates/confirm.popup.html",cssClass:"eserviss-confirm",scope:$scope});$scope.onSubmitTapped=function(code){var validator=new Validator;if(validator.isEmpty(code,"Please enter confirmation code you recieved via sms")){$rootScope.onError.fire(validator.getError());return}User.getInstance().verifyMobile(code,new Callback(function(){popupConfirmCode.close();User.InitPushNotification();$ionicHistory.nextViewOptions({disableBack:true});User.getInstance().store();User.getInstance().ping();$state.go("menu.hailrequest")}),$rootScope.onError)}}),$rootScope.onError)};popupConfirmPhone=$ionicPopup.confirm({templateUrl:"templates/confirm.popup.html",cssClass:"eserviss-confirm",scope:$scope})}),$rootScope.onError)}}]);controllers.controller("UserController@signup",["$scope","$state","$stateParams","$ionicPopup","$translate","Util","$timeout","User","Callback","$rootScope","Country","Validator","$ionicModal","Mode",function($scope,$state,$stateParams,$ionicPopup,$translate,Util,$timeout,User,Callback,$rootScope,Country,Validator,$ionicModal,Mode){"use strict";Mode.FindAll();var popupConfirmPhone=null,popupConfirmCode=null;$scope.signup={country:"Lebanon",mobile:{code:"+961"},gender:{}};var onMobileConfirmed=new Callback(function(){var validator=new Validator;validator.isEmpty($scope.signup.firstName,"Please enter your first name","signup-firstName");validator.isEmpty($scope.signup.lastName,"Please enter your last name","signup-lastName");validator.isEmpty($scope.signup.email,"Please enter your email address","signup-email");validator.isEmpty($scope.signup.password,"Please enter your password","signup-password");validator.isEmpty($scope.signup.country,"Please enter your country","signup-country");validator.isEmpty($scope.signup.mobile.code,"Please enter your mobile country code");validator.isEmpty($scope.signup.mobile.number,"Please enter your mobile number","signup-mobile");validator.isEmpty($scope.signup.gender.value,"Please enter your gender","signup-gender");if(!validator.isPassed()){$rootScope.onError.fire(validator.getErrorBlock());return}User.getInstance().firstName=$scope.signup.firstName;User.getInstance().lastName=$scope.signup.lastName;User.getInstance().email=$scope.signup.email;User.getInstance().password=$scope.signup.password;User.getInstance().country=$scope.signup.country;User.getInstance().mobile=Util.String("{0}{1}",[$scope.signup.mobile.code,$scope.signup.mobile.number]);User.getInstance().gender=$scope.signup.gender.value;User.getInstance().signup(new Callback(function(){$ionicHistory.nextViewOptions({disableBack:true});User.getInstance().store();User.getInstance().ping();$state.go("menu.hailrequest")}),$rootScope.onError)});var popupMobileConfirm=function(){var phoneNumber=$scope.signup.mobile&&$scope.signup.mobile.code&&$scope.signup.mobile.number?Util.String("{0} {1}",[$scope.signup.mobile.code,$scope.signup.mobile.number]):"";
$scope.confirm={message:null,buttons:{isSubmit:false},input:{data:phoneNumber,isAllowed:false}};$translate("IS_YOUR_MOBILE").then(function(confirmCodeMessage){$scope.confirm.message=confirmCodeMessage});popupConfirmPhone=$ionicPopup.confirm({templateUrl:"templates/confirm.popup.html",cssClass:"eserviss-confirm",scope:$scope});$scope.onYesTapped=function(){popupConfirmPhone.close();User.getInstance().signup(new Callback(function(){popupConfirmCode=$ionicPopup.confirm({templateUrl:"templates/confirm.popup.html",cssClass:"eserviss-confirm",scope:$scope});$scope.confirm.buttons.isSubmit=true;$scope.confirm.input.isAllowed=true;$scope.confirm.input.placeholder=null;$scope.confirm.input.data=null;$translate(["CONFIRM_CODE_MESSAGE","CONFIRMATION_CODE"]).then(function(translations){$scope.confirm.message=translations.CONFIRM_CODE_MESSAGE;$scope.confirm.input.placeholder=translations.CONFIRMATION_CODE});$scope.onSubmitTapped=function(code){var validator=new Validator;if(validator.isEmpty(code,"Please enter confirmation code you recieved via sms")){$rootScope.onError.fire(validator.getError());return}User.getInstance().verifyMobile(code,new Callback(function(){popupConfirmCode.close();$state.go("menu.hailrequest")}),$rootScope.onError)}}),$rootScope.onError)};$scope.onNoTapped=function(){popupConfirmPhone.close()}};$scope.onCountryTapped=function(){if(typeof cordova==="undefined"){$scope.signup.country="Lebanon";$scope.signup.mobile.code="+961";return}var countryConfig={title:"Select a Country",items:[],selectedValue:"202",doneButtonLabel:"Done",cancelButtonLabel:"Cancel"};Country.FindAll(new Callback(function(countries){for(var i=0;i<countries.length;i++){countryConfig.items.push({text:countries[i].name,value:i})}plugins.listpicker.showPicker(countryConfig,function(countryIndex){$scope.$apply(function(){$scope.signup.country=countries[countryIndex].name;$scope.signup.mobile.code=Util.String("{0}{1}",["+",countries[countryIndex].phoneCode])})},function(){})}),$rootScope.onError)};$scope.onGenderTapped=function(){if(typeof cordova==="undefined"){$scope.signup.gender={text:"Male",value:"MALE"};return}$translate(["MALE","FEMALE"]).then(function(translations){var genderConfig={title:"Select a Gender",items:[{text:translations.MALE,value:"MALE"},{text:translations.FEMALE,value:"FEMALE"}],doneButtonLabel:"Done",cancelButtonLabel:"Cancel"};plugins.listpicker.showPicker(genderConfig,function(gender){var genderItem=Util.Find(genderConfig.items,function(item){return item.value==gender});$scope.$apply(function(){$scope.signup.gender=genderItem})},function(){})})};$scope.onNextTapped=function(signup){var validator=new Validator;var validator=new Validator;validator.isEmpty($scope.signup.firstName,"Enter your first name","signup-firstName");validator.isEmpty($scope.signup.lastName,"Enter your last name","signup-lastName");validator.isEmpty($scope.signup.email,"Enter your email address","signup-email");validator.isEmpty($scope.signup.password,"Enter your password","signup-password");validator.isEmpty($scope.signup.country,"Enter your country","signup-country");validator.isEmpty($scope.signup.mobile.code,"Enter your mobile country code","signup-mobilecode");validator.isEmpty($scope.signup.mobile.number,"Enter your mobile number","signup-mobilenumber");validator.isEmpty($scope.signup.gender.value,"Enter your gender","signup-gender");if(!validator.isPassed()){$rootScope.onError.fire(validator.getErrorBlock());return}User.getInstance().firstName=$scope.signup.firstName;User.getInstance().lastName=$scope.signup.lastName;User.getInstance().email=$scope.signup.email;User.getInstance().password=$scope.signup.password;User.getInstance().country=$scope.signup.country;User.getInstance().mobile=Util.String("{0}{1}",[$scope.signup.mobile.code,$scope.signup.mobile.number]);User.getInstance().gender=$scope.signup.gender.value;popupMobileConfirm()};$ionicModal.fromTemplateUrl("templates/privacy.modal.html",{scope:$scope}).then(function(modal){$scope.onPrivacyTapped=function(){modal.show()};$scope.onHidePolicyTapped=function(){modal.hide()};$scope.$on("$destroy",function(){modal.remove()})});$ionicModal.fromTemplateUrl("templates/terms.modal.html",{scope:$scope}).then(function(modal){$scope.onTermsTapped=function(){modal.show()};$scope.onHideTermsTapped=function(){modal.hide()};$scope.$on("$destroy",function(){modal.remove()})})}]);controllers.controller("UserController@profile",["$scope","$state","$stateParams","User","ImageManager","Callback","$rootScope","Settings","Error","Util","$ionicHistory","$cordovaDialogs","Validator",function($scope,$state,$stateParams,User,ImageManager,Callback,$rootScope,Settings,Error,Util,$ionicHistory,$cordovaDialogs,Validator){"use strict";$scope.user={firstName:User.getInstance().firstName.charAt(0).toUpperCase()+User.getInstance().firstName.substring(1),lastName:User.getInstance().lastName.charAt(0).toUpperCase()+User.getInstance().lastName.substring(1),gender:User.getInstance().gender,email:User.getInstance().email,mobile:User.getInstance().mobile,profilePicture:User.getInstance().profilePicture};var imageManager=new ImageManager;var validateProfilePicture=function(imageUrl,onSuccess){var defaultError=new Error("Error happened while setting profile picture, please try again");if(!imageUrl){$rootScope.onError.fire(defaultError);return}var MAX_SIZE=5*1024*1024;imageManager.fileMetadata(new Callback(function(metadata){if(!metadata.isImage())$rootScope.onError.fire(new Error("Please select an image type"));else if(metadata.size>MAX_SIZE)$rootScope.onError.fire(new Error("Please select an image less than 20 MB size"));else{onSuccess.fire()}}),$rootScope.onError)};$scope.onCameraTapped=function(){imageManager.locationed().fromCamera(new Callback(function(imageUrl){validateProfilePicture(imageUrl,new Callback(function(){$scope.user.profilePicture=imageUrl;$scope.$apply()}))}))};$scope.onGalleryTapped=function(){imageManager.locationed().fromGallery(new Callback(function(imageUrl){validateProfilePicture(imageUrl,new Callback(function(){$scope.user.profilePicture=imageUrl;$scope.$apply()}))}))};$scope.onEmergencyNumberTapped=function(){plugins.CallNumber.callNumber(function(){},function(e){$rootScope.onError.fire(new Error("Error while calling Eserviss emergency, try again later"))},Settings.getInstance().e_number)};$scope.onSaveTapped=function(profile){var validator=new Validator;validator.isEmpty(profile.firstName,"First name can't be empty","profile-firstName");validator.isEmpty(profile.lastName,"Last name can't be empty","profile-lastName");validator.isEmpty(profile.gender,"Gender can't be empty","profile-gender");validator.isEmpty(profile.email,"Email can't be empty","profile-email");validator.isEmpty(profile.mobile,"Mobile can't be empty","profile-mobile");if(!validator.isPassed()){$rootScope.onError.fire(validator.getErrorBlock());return}$rootScope.onProgress.fire();User.getInstance().updateProfile(profile,imageManager,new Callback(function(){$rootScope.onProgressDone.fire();$cordovaDialogs.alert("Your profile is updated successfully","Profile Update")}),$rootScope.onError)};$scope.onLogoutTapped=function(){$ionicHistory.nextViewOptions({disableBack:true});User.getInstance().logout();$state.go("landing")}}]);controllers.controller("UserController@forget",["$scope","$state","$stateParams","User","$ionicPopup","Validator","Callback","$rootScope","Error","$cordovaDialogs",function($scope,$state,$stateParams,User,$ionicPopup,Validator,Callback,$rootScope,Error,$cordovaDialogs){"use strict";var popupConfirmPhone=null;var STATE={VERIFY_MOBILE:0,RESET_PASSWORD:1};$scope.STATE=STATE;$scope.forgot={};$scope.state=STATE.VERIFY_MOBILE;$scope.onSmsTapped=function(forgot){var mobileValidator=new Validator;mobileValidator.isEmpty(forgot.mobile,"Mobile can't be empty","forgot-mobile");if(!mobileValidator.isPassed()){$rootScope.onError.fire(mobileValidator.getError());return}User.getInstance().mobile=forgot.mobile;User.getInstance().forgotPasswordSendSms(new Callback(function(){$scope.confirm={message:"Please enter confirmation code you recieved via sms!",buttons:{isSubmit:true},input:{placeholder:"CONFIRMATION CODE",isAllowed:true}};$scope.onSubmitTapped=function(code){popupConfirmPhone.close();User.getInstance().forgotPasswordValidateMobile(code,new Callback(function(){$scope.state=STATE.RESET_PASSWORD}),$rootScope.onError)};popupConfirmPhone=$ionicPopup.confirm({templateUrl:"templates/confirm.popup.html",cssClass:"eserviss-confirm",scope:$scope})}),$rootScope.onError)};$scope.onResetTapped=function(forgot){var passwordValidator=new Validator;passwordValidator.isEmpty(forgot.password,"Password can't be empty","forgot-password");passwordValidator.isEmpty(forgot.confirmPassword,"Confirm password can't be empty","forgot-confirm-password");if(forgot.password!==forgot.confirmPassword){$rootScope.onError.fire(new Error("password don't match"));return}if(!passwordValidator.isPassed()){$rootScope.onError.fire(passwordValidator.getError());return}User.getInstance().password=forgot.password;User.getInstance().forgotPasswordReset(new Callback(function(){$cordovaDialogs.alert("Your password is reseted successfully","Password Reset").then(function(){$state.go("header.signin")})}),$rootScope.onError)}}]);controllers.controller("UserController@paymentsettings",["$scope","$state","$stateParams","$rootScope","User","Util","Callback","Validator","$cordovaDialogs",function($scope,$state,$stateParams,$rootScope,User,Util,Callback,Validator,$cordovaDialogs){"use strict";$scope.card={};$scope.creditCards=[];User.getInstance().findCreditCards(new Callback(function(creditCards){$scope.creditCards=creditCards;$scope.$apply()}),$rootScope.onError);var validateCreditInputs=function(credit){var validator=new Validator;validator.isEmpty(credit.name,"Please enter a valid credit card name","payment-cardname");validator.isEmpty(credit.number,"Please enter a valid credit card number","payment-cardnumber");validator.isEmpty(credit.cvc,"Please enter a valid credit card CVC","payment-cardcvc");validator.isEmpty(credit.exp_month,"Please enter a valid 2 DIGIT expiry month","payment-exp_month");validator.isEmpty(credit.exp_year,"Please enter a valid 2 DIGIT expiry year","payment-exp_year");if(!validator.isPassed()){$rootScope.onError.fire(validator.getErrorBlock());return false}return true};$scope.onEditSaveTapped=function(credit){if(validateCreditInputs(credit)){$rootScope.onProgress.fire();User.getInstance().saveCreditCard(credit,new Callback(function(motivationMessage){$rootScope.onProgressDone.fire();$cordovaDialogs.alert(motivationMessage,"Credit Card").then(function(){$state.go("menu.ridecredit")})}),$rootScope.onError)}};$scope.onPrepaidSubmitTapped=function(prepaidCode){var validator=new Validator;if(validator.isEmpty(prepaidCode,"Please enter a valid prepaid card code")){$rootScope.onError.fire(validator.getError());return}User.getInstance().prepaidCard(prepaidCode,new Callback(function(amount){$scope.prepaid="";User.getInstance().findCredit(new Callback(function(credit){console.log(credit);$cordovaDialogs.alert(Util.String("your account is recharged with {0} successfully, and your balance now is {1}",[amount,credit.cash]),"PrepaidCard")}),$rootScope.onError)}),$rootScope.onError)}}]);controllers.controller("UserController@ridecredit",["$scope","$state","$stateParams","User","Callback","$rootScope","Util","$cordovaDialogs","Validator","Error",function($scope,$state,$stateParams,User,Callback,$rootScope,Util,$cordovaDialogs,Validator,Error){"use strict";$scope.recharge={};$scope.credit=null;var findCredit=function(){User.getInstance().findCredit(new Callback(function(credit){console.log(credit);$scope.credit=credit;$scope.$apply()}),$rootScope.onError)};findCredit();var validateRechargeInputs=function(recharge){if(!User.getInstance().isStripeCustomerCreated()){$rootScope.onError.fire(new Error("Please enter your credit card first"));return false}var validator=new Validator;if(validator.isEmpty(recharge.amount,"Please enter a valid recharge amount")){$rootScope.onError.fire(validator.getError());return false}return true};$scope.onSubmitTapped=function(recharge){if(validateRechargeInputs(recharge)){var amount=recharge.amount*100;User.getInstance().recharge(amount,new Callback(function(){findCredit();$cordovaDialogs.alert(Util.String("Your account is charged successfuly with {0}$",[recharge.amount]),"Recharge")}),$rootScope.onError)}}}]);controllers.controller("UserController@blacklist",["$scope","$state","$stateParams","User","Callback","$rootScope","Util",function($scope,$state,$stateParams,User,Callback,$rootScope,Util){"use strict";var fakeProgress=angular.element(document.getElementById("fake-progress")),spamProgress=angular.element(document.getElementById("spam-progress"));User.getInstance().findBlacklist(new Callback(function(r){fakeProgress.css("width",Util.String("{0}%",[r.fake]));spamProgress.css("width",Util.String("{0}%",[r.spam]))}),$rootScope.onError)}]);controllers.controller("HailRequestController@request",["$scope","$state","$stateParams","mapEngine","$rootScope","Callback","User","Geolocation","$timeout","$ionicPopup","HailRequest","Mode","Util","$ionicLoading","$ionicPopover","$ionicHistory","Validator","$ionicSideMenuDelegate","$cordovaDialogs",function($scope,$state,$stateParams,mapEngine,$rootScope,Callback,User,Geolocation,$timeout,$ionicPopup,HailRequest,Mode,Util,$ionicLoading,$ionicPopover,$ionicHistory,Validator,$ionicSideMenuDelegate,$cordovaDialogs){"use strict";var REQUEST_STATE={INIT:0,HAIL:1,PICKUP:2,DROPOFF:3,MEETING_POINT:3.5,CONFIRM_MEETING_POINT:3.75,FARE:4};$scope.REQUEST_STATE=REQUEST_STATE;var fareConfirm=null,commentConfirm=null,meetingPointConfirm=null,dragDealer=null,pickmenuBorder=angular.element(document.getElementById("pickmenuBorder")),navBtn=null;$scope.requestState=REQUEST_STATE.INIT;$scope.request=new HailRequest;Mode.FindAll(new Callback(function(){console.log(Mode.FindById(Mode.ID.TAXI));$scope.request.setMode(Mode.FindById(Mode.ID.TAXI))}));var updateView=function(){var navBack=function(){navBtn=angular.element(document.getElementById("navBtn"));navBtn.removeClass("ion-navicon");navBtn.addClass("ion-arrow-left-c")};var navMenu=function(){navBtn=angular.element(document.getElementById("navBtn"));navBtn.removeClass("ion-arrow-left-c");navBtn.addClass("ion-navicon")};if($scope.requestState===REQUEST_STATE.INIT){mapEngine.navigationInfoWindowLeftText("img/icons/info-hail.png");mapEngine.navigationInfoWindowRightText("HAIL");navMenu();dragDealer.enable()}else if($scope.requestState===REQUEST_STATE.HAIL){mapEngine.navigationInfoWindowRightText("SET PICKUP");mapEngine.navigationInfoWindowLeftText("img/icons/info-pickup.png");navBack();dragDealer.disable()}else if($scope.requestState===REQUEST_STATE.PICKUP){mapEngine.navigationInfoWindowRightText("CONFIRM PICKUP");mapEngine.navigationInfoWindowLeftText("img/icons/info-pickup.png");pickmenuBorder.css("height","50%");navBack();dragDealer.disable()}else if($scope.requestState===REQUEST_STATE.MEETING_POINT){mapEngine.navigationInfoWindowRightText("MEETING POINT");mapEngine.navigationInfoWindowLeftText(null,$scope.request.nearestPoint.distance)}else if($scope.requestState===REQUEST_STATE.CONFIRM_MEETING_POINT){mapEngine.navigationInfoWindowRightText("CONFIRM");mapEngine.navigationInfoWindowLeftText("img/icons/info-dropoff.png")}else if($scope.requestState===REQUEST_STATE.DROPOFF){mapEngine.navigationInfoWindowRightText("CONFIRM DROPOFF");mapEngine.navigationInfoWindowLeftText("img/icons/info-dropoff.png");navBack();pickmenuBorder.css("height","75%");dragDealer.disable()}else if($scope.requestState===REQUEST_STATE.FARE){mapEngine.navigationInfoWindowRightText("WAIT");navBack();dragDealer.disable()}$scope.$apply()};var rebuildSyncedRequest=function(){if($stateParams.request!==null){$scope.request=$stateParams.request;if($scope.request.mode!==null){if($scope.request.mode.id===Mode.ID.SERVISS)dragDealer.setStep(1);else if($scope.request.mode.id===Mode.ID.SERVISS_PLUS)dragDealer.setStep(2);else if($scope.request.mode.id===Mode.ID.TAXI)dragDealer.setStep(3)}else{$scope.request.setMode(Mode.FindById(Mode.ID.SERVISS))}if($scope.request.pickupLocation!==null)$scope.requestState=REQUEST_STATE.PICKUP;else if($scope.request.dropoffLocation!==null)$scope.requestState=REQUEST_STATE.DROPOFF;updateView()}};var resetRequest=function(){if($scope.request.nearestPointWatch){console.log("nearestPointWatch",$scope.request.nearestPointWatch);$scope.request.nearestPointWatch.stopWatching()}mapEngine.gMapsInstance.removePolylines();$scope.requestState=REQUEST_STATE.INIT;$scope.request=new HailRequest;$scope.request.setMode(Mode.FindById(Mode.ID.TAXI));dragDealer.setStep(3);mapEngine.getMap().setZoom(14);updateView()};$scope.onResetTapped=resetRequest;$scope.onNavTapped=function(){if($scope.requestState===REQUEST_STATE.INIT)$ionicSideMenuDelegate.toggleLeft();else{resetRequest()}};var onNearbyCarsFound=new Callback(function(nearByCars){if(!mapEngine.isReady)return;mapEngine.gMapsInstance.removeMarkers();for(var i=0;i<nearByCars.length;i++){var position=Geolocation.ParsePosition(nearByCars[i].car_location);mapEngine.addMarker(position.lat(),position.lng(),nearByCars[i].image)}});var initModeSelect=function(){$scope.step=1;dragDealer=new Dragdealer("mode-select",{steps:3,loose:true,tapping:true,callback:function(x,y){$scope.step=dragDealer.getStep()[0];$scope.request.setMode(Mode.FromDragDealer($scope.step));User.getInstance().findNearbyCars($scope.request.mode,onNearbyCarsFound);$scope.$apply()}});dragDealer.reflow();dragDealer.setStep(3);Mode.FindAll(new Callback(function(){User.getInstance().findNearbyCars($scope.request.mode,onNearbyCarsFound)}))};var validateDropoffLocation=function(dropoffLocation){if(dropoffLocation===null)$rootScope.onError.fire(new Error("You can't set a dropoff location more than 10 KM"))};var onPlaceChanged=function(place){if(!place||!place.geometry)return;if(place.geometry.viewport){mapEngine.getMap().fitBounds(place.geometry.viewport)}else{mapEngine.getMap().setCenter(place.geometry.location)}mapEngine.getMap().setZoom(17)};$scope.onPickupLocationSelected=function(place){if(!place.geometry){$scope.request.pickupAddress=""}else{onPlaceChanged(place);$scope.request.pickupLocation=place.geometry.location}$scope.$apply()};$scope.onDropoffLocationSelected=function(place){if(!place.geometry){$scope.request.dropoffAddress=""}else{onPlaceChanged(place);$scope.request.dropoffLocation=place.geometry.location;validateDropoffLocation($scope.request.dropoffLocation)}$scope.$apply()};var initAutoCompleteServices=function(){var options={componentRestrictions:{country:"LB"}};var pickupInput=document.getElementById("pickup");var dropoffInput=document.getElementById("dropoff");var pickupAutocomplete=new google.maps.places.Autocomplete(pickupInput,options);var dropoffAutocomplete=new google.maps.places.Autocomplete(dropoffInput,options);pickupAutocomplete.bindTo("bounds",mapEngine.getMap());dropoffAutocomplete.bindTo("bounds",mapEngine.getMap());var onPlaceChanged=function(place){if(!place||!place.geometry)return;if(place.geometry.viewport){mapEngine.getMap().fitBounds(place.geometry.viewport)}else{mapEngine.getMap().setCenter(place.geometry.location);mapEngine.getMap().setZoom(17)}};google.maps.event.addListener(pickupAutocomplete,"place_changed",function(){var place=pickupAutocomplete.getPlace();if(!place.geometry){$scope.request.pickupAddress=""}else{onPlaceChanged(place);$scope.request.pickupLocation=place.geometry.location}$scope.$apply()});google.maps.event.addListener(dropoffAutocomplete,"place_changed",function(){var place=dropoffAutocomplete.getPlace();if(!place.geometry){$scope.request.dropoffAddress=""}else{onPlaceChanged(place);$scope.request.dropoffLocation=place.geometry.location;validateDropoffLocation($scope.request.dropoffLocation)}$scope.$apply()})};var initModesPopovers=function(){$ionicPopover.fromTemplateUrl("mode.popover.html",{scope:$scope}).then(function(popover){$scope.openPopover=function(event,step){if(!step)step=$scope.step;popover.show(event)};$scope.$on("$destroy",function(){popover.remove()})})};initModeSelect();initModesPopovers();$scope.onRequestPlusTapped=function(){if($scope.request.passengers<$scope.request.mode.maxPassengers)$scope.request.passengers++};$scope.onRequestMinusTapped=function(){if($scope.request.passengers>1)$scope.request.passengers--};mapEngine.ready(function(){var onDestinationLocationChange=new Callback(function(){var g=new Geolocation;$rootScope.onProgress.fire();var locationLatLng=mapEngine.getCenter();g.latlngToAddress(locationLatLng,new Callback(function(address){console.log(address);if(address.toUpperCase().indexOf("UNNAMED")>-1)address="No street name";if($scope.requestState===REQUEST_STATE.HAIL||$scope.requestState===REQUEST_STATE.PICKUP){$scope.request.pickupLocation=locationLatLng;$scope.request.pickupAddress=address;console.log($scope.request.pickupAddress)}else if($scope.requestState===REQUEST_STATE.DROPOFF){$scope.request.dropoffAddress=address;$scope.request.dropoffLocation=locationLatLng;validateDropoffLocation($scope.request.dropoffLocation)}$rootScope.onProgressDone.fire();$scope.$apply()}),$rootScope.onError)});mapEngine.gMapsInstance.on("dragend",function(){if($scope.requestState===REQUEST_STATE.PICKUP||$scope.requestState===REQUEST_STATE.DROPOFF)onDestinationLocationChange.fire()});var onHailRequestPickedup=new Callback(function(){mapEngine.drawRoute({origin:[$scope.request.pickupLocation.lat(),$scope.request.pickupLocation.lng()],destination:[$scope.request.dropoffLocation.lat(),$scope.request.dropoffLocation.lng()],travelMode:"driving",strokeColor:"#7EBBFE",strokeWeight:7});$scope.requestState=REQUEST_STATE.FARE;updateView();$scope.request.estimateCost(new Callback(function(cost){$scope.confirm={title:"FARE ESTIMATION",message:Util.String("{0} USD for {1}",[cost,$scope.request.mode.name]),buttons:{isSubmit:false,yes:"CONFIRM",no:"CANCEL",promotePositive:true}};$scope.onNoTapped=function(){fareConfirm.close();resetRequest()};$scope.onYesTapped=function(){fareConfirm.close();$scope.onSubmitTapped=function(comment){$scope.request.comment=comment;commentConfirm.close();$ionicLoading.show({template:"Matching you with a Driver now!"});$scope.request.make(User.getInstance(),new Callback(function(driver){mapEngine.gMapsInstance.off("dragend");$ionicLoading.hide();$ionicHistory.clearCache();$state.go("menu.requestconfirmed",{request:$scope.request})}),new Callback(function(e){$rootScope.onError.fire(e);$scope.requestState=REQUEST_STATE.DROPOFF;updateView()}))};$scope.confirm={message:"Send a Note About Your Location So Driver Can Find You Quicker",buttons:{isSubmit:true},input:{data:$scope.request.comment,placeholder:"I am next to beirut municipality entrance",isAllowed:true}};$timeout(function(){commentConfirm=$ionicPopup.confirm({templateUrl:"templates/confirm.popup.html",cssClass:"eserviss-confirm text-center",scope:$scope})},500)};fareConfirm=$ionicPopup.confirm({templateUrl:"templates/confirm.popup.html",cssClass:"eserviss-confirm text-center",scope:$scope})}),new Callback(function(e){$rootScope.onError.fire(e);$scope.requestState=REQUEST_STATE.DROPOFF;updateView()}))});var onLocationEnabled=new Callback(function(){$scope.myLocationTapped=function(){User.getInstance().findPosition(new Callback(function(position){mapEngine.addUserAccuracy(position.lat(),position.lng(),position.accuracy);mapEngine.setCenter(position.lat(),position.lng())}))};var g=new Geolocation;User.getInstance().findPosition(new Callback(function(position){mapEngine.addUserAccuracy(position.lat(),position.lng(),position.accuracy);mapEngine.setCenter(position.lat(),position.lng())}),$rootScope.onError);mapEngine.navigationMarker(function(){});mapEngine.navigationInfo(function(){if($scope.requestState===REQUEST_STATE.INIT){$scope.request.inService(new Callback(function(){onDestinationLocationChange.fire();$scope.requestState=REQUEST_STATE.PICKUP;updateView()}),$rootScope.onError)}else if($scope.requestState===REQUEST_STATE.HAIL){$scope.request.inService(new Callback(function(){onDestinationLocationChange.fire();$scope.requestState=REQUEST_STATE.PICKUP;updateView()}),$rootScope.onError)}else if($scope.requestState===REQUEST_STATE.PICKUP){$scope.request.inService(new Callback(function(){$scope.requestState=REQUEST_STATE.DROPOFF;updateView()}),$rootScope.onError)}else if($scope.requestState===REQUEST_STATE.DROPOFF){var validator=new Validator;if(validator.isNull($scope.request.dropoffLocation,"Please enter dropoff location first")){$rootScope.onError.fire(validator.getError());return}$scope.request.inService(new Callback(function(){if($scope.request.mode.id===Mode.ID.SERVISS){$scope.request.validateServicePickup(new Callback(function(isNear){if(isNear){onHailRequestPickedup.fire();return}$scope.confirm={title:"MEETING POINT",message:$scope.request.nearestPoint.message,buttons:{isSubmit:false,yes:"ACCEPT",no:"CHOOSE TAXI"}};$scope.onNoTapped=function(){meetingPointConfirm.close();resetRequest()};$scope.onYesTapped=function(){var nearestPointImg=angular.element(document.getElementById("meetingpointImg"));meetingPointConfirm.close();$scope.requestState=REQUEST_STATE.MEETING_POINT;updateView();$scope.request.nearestPoint.header.line[0]=" START WALKING TOWARDS MEETING POINT NOW";nearestPointImg.css("vertical-align","middle");$scope.request.watchToMeetingPoint(new Callback(function(userPosition){mapEngine.drawRoute({origin:[userPosition.lat(),userPosition.lng()],destination:[$scope.request.nearestPoint.location.lat(),$scope.request.nearestPoint.location.lng()],travelMode:"walking",strokeColor:"#7EBBFE",strokeWeight:7});mapEngine.setCenter($scope.request.nearestPoint.location.lat(),$scope.request.nearestPoint.location.lng())}),new Callback(function(){$scope.request.nearestPoint.header.line[0]="YOU HAVE REACHED YOUR MEETING POINT!";$scope.request.nearestPoint.header.line[1]="PLEASE CONFIRM YOUR RIDE REQUEST";nearestPointImg.css("vertical-align","top");$scope.requestState=REQUEST_STATE.CONFIRM_MEETING_POINT;updateView()}),new Callback(function(){$scope.request.nearestPoint.header.line[0]="YOU ARE CLOSE TO MEETING POINT";nearestPointImg.css("vertical-align","middle")},1),$rootScope.onError)};meetingPointConfirm=$ionicPopup.confirm({templateUrl:"templates/confirm.popup.html",cssClass:"eserviss-confirm text-center",scope:$scope})}),$rootScope.onError)}else{onHailRequestPickedup.fire()}}),$rootScope.onError)}else if($scope.requestState===REQUEST_STATE.MEETING_POINT){$cordovaDialogs.alert("Eserviss is wathcing your position until you reach the meeting point","Meeting Point")}else if($scope.requestState===REQUEST_STATE.CONFIRM_MEETING_POINT){mapEngine.gMapsInstance.removePolylines();$scope.request.pickupLocation=$scope.request.nearestPoint.location.toLatLng();var g=new Geolocation;g.latlngToAddress($scope.request.pickupLocation,new Callback(function(address){$scope.request.pickupAddress=address;$scope.$apply()}));onHailRequestPickedup.fire()}$scope.$apply()});updateView();rebuildSyncedRequest()});$rootScope.ifLocationEnabled(onLocationEnabled)});$scope.$on("$destroy",function(){})}]);controllers.controller("HailRequestController@confirmed",["$scope","$state","$stateParams","mapEngine","User","$rootScope","Callback","Util","Geolocation",function($scope,$state,$stateParams,mapEngine,User,$rootScope,Callback,Util,Geolocation){"use strict";var confirmedScrollElem=angular.element(document.getElementById("confirmedScroll")),infoElem=angular.element(document.getElementById("info")),geolocation=new Geolocation;$scope.request=$stateParams.request;$scope.infoState=1;$scope.onCloseTapped=function(){if($scope.infoState===1){confirmedScrollElem.removeClass("slideOutDown");confirmedScrollElem.removeClass("slideInDown");confirmedScrollElem.addClass("slideOutDown");infoElem.css("height","auto");$scope.infoState=0}else if($scope.infoState===0){confirmedScrollElem.removeClass("slideOutDown");confirmedScrollElem.removeClass("slideInDown");confirmedScrollElem.addClass("slideInDown");infoElem.css("height","50%");$scope.infoState=1}};$scope.onContactTapped=function(){plugins.listpicker.showPicker({title:"Contact Driver",items:[{text:"Send a Message",value:"MESSAGE"},{text:"Call Driver",value:"CALL"}]},function(action){if(action==="MESSAGE"){plugins.socialsharing.shareViaSMS({message:""},$scope.driver.DriverPhone,null,function(){})}else if(action==="CALL"){plugins.CallNumber.callNumber(function(){},function(e){$rootScope.onError.fire(new Error(e,true,true))},$scope.driver.DriverPhone)}},function(){})};$scope.onShareEtaTapped=function(){var POST_MESSAGE=Util.String("Get Eserviss app at http://eserviss.com/app");var POST_TITLE="Eserviss";plugins.socialsharing.share(POST_MESSAGE,POST_TITLE)};var initSync=function(){$scope.request.sync(User.getInstance(),new Callback(function(){$scope.$apply()}),$rootScope.onError);$scope.request.onDroppedoff=new Callback(function(){geolocation.stopWatching();$state.go("menu.receipt",{request:$scope.request})})};initSync();var onLocationEnabled=new Callback(function(){User.getInstance().findPosition(new Callback(function(position){mapEngine.addUserAccuracy(position.lat(),position.lng(),position.accuracy);mapEngine.setCenter(position.lat(),position.lng())}),$rootScope.onError);mapEngine.drawRoute({origin:[$scope.request.pickupLocation.lat(),$scope.request.pickupLocation.lng()],destination:[$scope.request.dropoffLocation.lat(),$scope.request.dropoffLocation.lng()],travelMode:"driving",strokeColor:"#7EBBFE",strokeWeight:7});geolocation.watch(new Callback(function(position){mapEngine.addUserAccuracy(position.lat(),position.lng(),position.accuracy);mapEngine.setCenter(position.lat(),position.lng())}))});mapEngine.ready(function(){$rootScope.ifLocationEnabled(onLocationEnabled)});$scope.$on("$destroy",function(){geolocation.stopWatching()})}]);controllers.controller("HailRequestController@receipt",["$scope","$state","$stateParams","Validator","$rootScope","Callback","$ionicHistory","User","$cordovaDialogs",function($scope,$state,$stateParams,Validator,$rootScope,Callback,$ionicHistory,User,$cordovaDialogs){"use strict";$ionicHistory.nextViewOptions({disableBack:true});var today=new Date;$scope.date={day:today.getDate(),month:today.toDateString().split(" ")[1],year:today.getFullYear()};$scope.request=$stateParams.request;$scope.receipt={};User.getInstance().findCredit(new Callback(function(credit){if(credit.cash<$scope.request.totalCost){$cordovaDialogs.alert("Please pay the trip cost to the driver","Trip Cost")}else{$scope.request.consumeCost(User.getInstance(),new Callback(function(){$cordovaDialogs.alert("Your trip cost has been charged from your balance","Trip Cost")}),$rootScope.onError)}}),$rootScope.onError);$scope.onSubmitTapped=function(receipt){var validator=new Validator;if(validator.isEmpty(receipt.rating,"Please insert rating first in your feedback")||validator.isEmpty(receipt.comment,"Please insert comment first in your feedback")){$rootScope.onError.fire(validator.getError());return}$scope.request.feedback(User.getInstance(),$scope.receipt.rating,$scope.receipt.comment,new Callback(function(){$state.go("menu.hailrequest")}),$rootScope.onError)}}]);controllers.controller("FavoriteController@favorties",["$scope","$state","$stateParams","User","Callback","$rootScope",function($scope,$state,$stateParams,User,Callback,$rootScope){"use strict";User.getInstance().findFavorites(new Callback(function(favorites){$scope.favorites=favorites.splice(0,4)}),$rootScope.onError);$scope.onFavoriteTapped=function(favorite,i){console.log(favorite,i);$state.go("menu.addfavorite",{mode:i,favorite:favorite})}}]);controllers.controller("FavoriteController@addfavorite",["$scope","$state","$stateParams","Favorite","Validator","mapEngine","Callback","User","$rootScope","Geolocation","$cordovaDialogs",function($scope,$state,$stateParams,Favorite,Validator,mapEngine,Callback,User,$rootScope,Geolocation,$cordovaDialogs){"use strict";$scope.mode=$stateParams.mode;
$scope.favorite=$stateParams.favorite;$scope.onSetLocationTapped=function(favorite){var validator=new Validator;validator.isEmpty(favorite.name,"Please enter a valid name","addfavorite-name");validator.isEmpty(favorite.address,"Please enter a valid address","addfavorite-address");validator.isNull(favorite.location,"Please enter a valid location","addfavorite-address");if(!validator.isPassed()){$rootScope.onError.fire(validator.getError());return}$scope.favorite.save(new Callback(function(){$cordovaDialogs.alert("Favorite is saved successfuly","Favorite").then(function(){$state.go("menu.favorites")})}),$rootScope.onError)};var onLocationEnabled=new Callback(function(){$scope.myLocationTapped=function(){User.getInstance().findPosition(new Callback(function(position){mapEngine.addUserAccuracy(position.lat(),position.lng(),position.accuracy);mapEngine.setCenter(position.lat(),position.lng())}))};mapEngine.navigationMarker(function(){});User.getInstance().findPosition(new Callback(function(position){mapEngine.addUserAccuracy(position.lat(),position.lng(),position.accuracy);mapEngine.setCenter(position.lat(),position.lng());mapEngine.gMapsInstance.on("dragend",function(){var g=new Geolocation;$rootScope.onProgress.fire();var locationLatLng=mapEngine.getCenter();g.latlngToAddress(locationLatLng,new Callback(function(address){if(address.toUpperCase().indexOf("UNNAMED")>-1)address="No street name";$scope.favorite.address=address;$scope.favorite.location=locationLatLng;$rootScope.onProgressDone.fire();$scope.$apply()}),$rootScope.onError)})}),$rootScope.onError)});mapEngine.ready(function(){if($scope.favorite.location.lat()&&$scope.favorite.location.lng()){mapEngine.setCenter($scope.favorite.location.lat(),$scope.favorite.location.lng())}$rootScope.ifLocationEnabled(onLocationEnabled)});$scope.onAddressSelected=function(place){if(!place||!place.geometry)return;if(place.geometry.viewport){mapEngine.getMap().fitBounds(place.geometry.viewport)}else{mapEngine.getMap().setCenter(place.geometry.location)}mapEngine.getMap().setZoom(17)};$scope.$on("$destroy",function(){mapEngine.gMapsInstance.off("dragend")})}]);controllers.controller("GuestController@share",["$scope","$state","$stateParams","User","Callback","$rootScope","Util",function($scope,$state,$stateParams,User,Callback,$rootScope,Util){"use strict";var POST_MESSAGE="Get Eserviss app at http://eserviss.com/app";var POST_TITLE="Eserviss";User.getInstance().findShare(new Callback(function(share){$scope.share=share;POST_MESSAGE=Util.String("Get Eserviss app at http://eserviss.com/app, Referal code is {0}",[share.code])}),$rootScope.onError);$scope.onCopyReferalLink=function(){if(typeof cordova==="undefined")return;cordova.plugins.clipboard.copy(POST_MESSAGE);$cordovaToast.showLongBottom("Your referal link copied").then(function(success){},function(error){})};var shareActionsheet=function(message,title){if(!message)message=POST_MESSAGE;if(!title)title=POST_TITLE;plugins.socialsharing.share(message,title)};$scope.onSmsTapped=function(){plugins.socialsharing.shareViaSMS({message:POST_MESSAGE},null,null,shareActionsheet)};$scope.onFacebookTapped=function(){plugins.socialsharing.shareViaFacebookWithPasteMessageHint(POST_MESSAGE,null,null,"Your referal post is copied, paste it if you like",null,shareActionsheet)};$scope.onGoogleTapped=function(){if(ionic.Platform.isAndroid()){plugins.socialsharing.shareVia("com.google.android.apps.plus",POST_MESSAGE,POST_TITLE,null,null,null,shareActionsheet)}else{shareActionsheet()}};$scope.onTwitterTapped=function(){plugins.socialsharing.shareViaTwitter(POST_MESSAGE,null,null,null,shareActionsheet)};$scope.onWhatsappTapped=function(){plugins.socialsharing.shareViaWhatsApp(POST_MESSAGE,null,null,null,shareActionsheet)}}]);controllers.controller("PromoController@promotions",["$scope","$state","$stateParams","Promotion","User","$rootScope","Callback",function($scope,$state,$stateParams,Promotion,User,$rootScope,Callback){"use strict";Promotion.FindAll(User.getInstance(),new Callback(function(promotions){$scope.promotions=promotions}),$rootScope.onError)}]);